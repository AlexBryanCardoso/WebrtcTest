<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Chat with Firebase</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>WebRTC Video Chat</h1>
        <div class="video-container">
            <video id="localVideo" autoplay playsinline></video>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        <div class="controls">
            <button id="startButton">Start Stream</button>
            <button id="callButton" disabled>Create Room</button>
            <button id="hangupButton" disabled>Hang Up</button>
            <div class="room-controls">
                <input type="text" id="roomId" placeholder="Enter Room ID">
                <button id="joinButton" disabled>Join Room</button>
            </div>
        </div>
    </div>

    Firebase App (the core Firebase SDK) -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script> -->
    <!-- Firebase Authentication -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script> -->
    <!-- Firebase Realtime Database -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script> -->
    
    <!-- Your Firebase configuration -->
    <!-- <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDE8AYlrR28IwDSNKSg2-KUo0ypKazeiNk",
            authDomain: "dev-project-46310.firebaseapp.com",
            projectId: "dev-project-46310",
            storageBucket: "dev-project-46310.firebasestorage.app",
            messagingSenderId: "880060702120",
            appId: "1:880060702120:web:93a1142fa3085d3568919d",
            measurementId: "G-JF87DTKG8J"
        };
    </script>

    <script src="js/main.js"></script>
</body>
</html> -->

<!-- index.html (minimal) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Camera Stream</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        .video-container {
            margin: 20px 0;
        }
        video {
            width: 640px;
            height: 360px;
            border: 1px solid #ccc;
            background: #000;
        }
        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IP Camera Stream</h1>
        <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
        </div>
        <div id="status">Connecting to stream...</div>
    </div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');

        async function startStream() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname === 'localhost' ? 'localhost:8889' : window.location.host;
                
                const response = await fetch('/stream');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const webrtcUrl = await response.text();
                
                // Create WebRTC connection
                const pc = new RTCPeerConnection({
                    iceServers: [{
                        urls: ['stun:stun.l.google.com:19302']
                    }]
                });

                pc.onicecandidate = e => {
                    if (!e.candidate) return;
                    console.log('Got candidate:', e.candidate);
                };

                pc.ontrack = e => {
                    if (e.track.kind === 'video') {
                        video.srcObject = e.streams[0];
                        status.textContent = 'Stream connected';
                        status.className = 'connected';
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    console.log('ICE Connection State:', pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
                        status.textContent = 'Connection lost, retrying...';
                        status.className = 'error';
                        pc.close();
                        setTimeout(startStream, 5000);
                    }
                };

                try {
                    const mediaStream = await navigator.mediaStream.getUserMedia({ video: true });
                    mediaStream.getTracks().forEach(track => pc.addTrack(track, mediaStream));
                } catch (err) {
                    console.log('No camera available, continuing with receive-only');
                }

                const offer = await pc.createOffer({
                    offerToReceiveVideo: true,
                    offerToReceiveAudio: true
                });
                
                await pc.setLocalDescription(offer);
                
                const response2 = await fetch(webrtcUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'offer',
                        sdp: pc.localDescription.sdp
                    })
                });

                const answer = await response2.json();
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
                
                status.textContent = 'Connecting...';
            } catch (error) {
                console.error('Error:', error);
                status.textContent = 'Connection error, retrying...';
                status.className = 'error';
                setTimeout(startStream, 5000);
            }
        }

        // Start stream when page loads
        startStream();
    </script>
</body>
</html>
</body>
</html>