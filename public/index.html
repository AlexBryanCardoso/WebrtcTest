<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Chat with Firebase</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>WebRTC Video Chat</h1>
        <div class="video-container">
            <video id="localVideo" autoplay playsinline></video>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        <div class="controls">
            <button id="startButton">Start Stream</button>
            <button id="callButton" disabled>Create Room</button>
            <button id="hangupButton" disabled>Hang Up</button>
            <div class="room-controls">
                <input type="text" id="roomId" placeholder="Enter Room ID">
                <button id="joinButton" disabled>Join Room</button>
            </div>
        </div>
    </div>

    Firebase App (the core Firebase SDK) -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script> -->
    <!-- Firebase Authentication -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script> -->
    <!-- Firebase Realtime Database -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script> -->
    
    <!-- Your Firebase configuration -->
    <!-- <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDE8AYlrR28IwDSNKSg2-KUo0ypKazeiNk",
            authDomain: "dev-project-46310.firebaseapp.com",
            projectId: "dev-project-46310",
            storageBucket: "dev-project-46310.firebasestorage.app",
            messagingSenderId: "880060702120",
            appId: "1:880060702120:web:93a1142fa3085d3568919d",
            measurementId: "G-JF87DTKG8J"
        };
    </script>

    <script src="js/main.js"></script>
</body>
</html> -->

<!-- index.html (minimal) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Camera Stream</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        .video-container {
            margin: 20px 0;
        }
        video {
            width: 640px;
            height: 360px;
            border: 1px solid #ccc;
            background: #000;
        }
        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IP Camera Stream</h1>
        <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
        </div>
        <div id="status">Connecting to stream...</div>
    </div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');

        async function startStream() {
            try {
                const response = await fetch('/stream');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Get the redirect URL from the response
                const redirectUrl = response.headers.get('location');
                if (!redirectUrl) {
                    throw new Error('No redirect URL provided by server');
                }
                console.log('WebRTC URL:', redirectUrl);
                
                // Create WebRTC connection with STUN servers
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: ['stun:stun.l.google.com:19302'] },
                        { urls: ['stun:stun1.l.google.com:19302'] }
                    ]
                });

                // Log ICE candidates for debugging
                pc.onicecandidate = e => {
                    if (e.candidate) {
                        console.log('Got ICE candidate:', e.candidate.candidate);
                    }
                };

                // Handle incoming video stream
                pc.ontrack = e => {
                    console.log('Received track:', e.track.kind);
                    if (e.track.kind === 'video') {
                        video.srcObject = e.streams[0];
                        status.textContent = 'Stream connected';
                        status.className = 'connected';
                    }
                };

                // Handle connection state changes
                pc.oniceconnectionstatechange = () => {
                    console.log('ICE Connection State:', pc.iceConnectionState);
                    if (['failed', 'disconnected', 'closed'].includes(pc.iceConnectionState)) {
                        status.textContent = 'Connection lost, retrying...';
                        status.className = 'error';
                        pc.close();
                        setTimeout(startStream, 5000);
                    }
                };

                // Create a receive-only offer
                const offer = await pc.createOffer({
                    offerToReceiveVideo: true,
                    offerToReceiveAudio: true
                });
                
                await pc.setLocalDescription(offer);
                console.log('Created offer:', offer.sdp);
                
                // Send offer to MediaMTX server
                const response2 = await fetch(redirectUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'offer',
                        sdp: offer.sdp
                    })
                });

                if (!response2.ok) {
                    throw new Error(`MediaMTX server error: ${response2.status}`);
                }

                const answer = await response2.json();
                console.log('Received answer:', answer);
                
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
                status.textContent = 'Connecting to stream...';
                
            } catch (error) {
                console.error('Connection error:', error);
                status.textContent = `Connection error: ${error.message}`;
                status.className = 'error';
                setTimeout(startStream, 5000);
            }
        }

        // Start stream when page loads
        startStream();
    </script>
</body>
</html>
</body>
</html>